stages:
  - build
  - test
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_REF_SLUG
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_REF_SLUG

cache:
  key: ${CI_PROJECT_NAME}
  paths:
    - frontend/.npm
    - backend/.npm

# ==================== BUILD STAGE ====================
build:backend:
  stage: build
  tags: 
    - vps
  image: docker:24-cli
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker build -t $BACKEND_IMAGE ./backend
    - docker push $BACKEND_IMAGE
  only:
    - main
    - develop
    - merge_requests

build:frontend:
  stage: build
  tags: 
    - vps
  image: docker:24-cli
  services:
    - name: docker:24-dind-rootless
      command: ["--tls=false"]
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin
    - docker build -t $FRONTEND_IMAGE ./frontend
    - docker push $FRONTEND_IMAGE
  only:
    - main
    - develop
    - merge_requests

# ==================== TEST STAGE ====================
test:backend:
  stage: test
  tags: 
    - vps
  image: node:18-alpine
  before_script:
    - cd backend
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run test --if-present
    - npm run lint --if-present
  only:
    - main
    - develop
    - merge_requests

test:frontend:
  stage: test
  tags: 
    - vps
  image: node:18-alpine
  before_script:
    - cd frontend
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run test --if-present
    - npm run lint --if-present
  only:
    - main
    - develop
    - merge_requests

# ==================== DEPLOY STAGE ====================
# deploy:staging:
#   stage: deploy
  # tags: 
  #   - vps
#   image: alpine:latest
#   before_script:
#     - apk add --no-cache openssh-client
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#     - mkdir -p ~/.ssh
#     - chmod 700 ~/.ssh
#     - ssh-keyscan -p $SSH_PORT $STAGING_SERVER >> ~/.ssh/known_hosts
#   script:
#     - ssh -o StrictHostKeyChecking=no -p $SSH_PORT $STAGING_USER@$STAGING_SERVER "
#         cd /root/shlo-space/note-app &&
#         echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin &&
#         docker compose pull &&
#         docker compose up -d &&
#         docker image prune -f"
#   environment:
#     name: staging
#     # url: https://staging.yourdomain.com
#   only:
#     - develop

deploy:production:
  stage: deploy
  tags: 
    - vps
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    # Decode the base64 SSH key and add it to the agent
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $SSH_PORT $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - ssh -o StrictHostKeyChecking=no -p $SSH_PORT $PRODUCTION_USER@$PRODUCTION_SERVER "
        cd /root/shlo-space/note-app &&
        echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER $CI_REGISTRY --password-stdin &&
        docker compose pull &&
        docker compose down &&
        docker compose up -d &&
        docker image prune -f"
  environment:
    name: production
    url: http://217.76.53.69:3000
  when: manual
  only:
    - main

rollback:production:
  stage: deploy
  tags: 
    - vps
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    # Decode the base64 SSH key
    - echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -p $SSH_PORT $PRODUCTION_SERVER >> ~/.ssh/known_hosts
  script:
    - ssh -o StrictHostKeyChecking=no -p $SSH_PORT $PRODUCTION_USER@$PRODUCTION_SERVER "
        cd /root/shlo-space/note-app &&
        docker compose down &&
        docker compose up -d --force-recreate"
  when: manual
  only:
    - main
